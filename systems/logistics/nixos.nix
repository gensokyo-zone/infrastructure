{
  pkgs,
  config,
  meta,
  lib,
  ...
}: let
  inherit (lib.modules) mkIf;
in {
  imports = let
    inherit (meta) nixos;
  in [
    nixos.sops
    nixos.base
    nixos.nginx
    nixos.barcodebuddy-scanner
    nixos.motion
    nixos.cameras.kitchen
    nixos.cameras.living
    nixos.cameras.logistics-webcam
    ./hardware-configuration.nix
  ];

  services.xserver = {
    enable = true;
    displayManager.lightdm.enable = true;
    desktopManager.xfce.enable = true;
  };
  services.libinput = {
    touchpad = {
      naturalScrolling = true;
    };
    mouse.naturalScrolling = config.services.libinput.touchpad.naturalScrolling;
  };
  programs.firefox.enable = true;
  services.motion.cameras.webcam.enable = false;

  services.printing.enable = true;

  services.pulseaudio.enable = false;
  security.rtkit.enable = true;
  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
    #jack.enable = true;
  };

  environment.systemPackages = [
  ];

  users.users.logistics = {
    uid = 1000;
    isNormalUser = true;
    description = "Logistics";
    extraGroups = [
      "nixbuilder"
      (mkIf (!config.services.octoprint.enable && !config.services.klipper.enable) "dialout")
      (mkIf config.networking.networkmanager.enable "networkmanager")
    ];
    hashedPasswordFile = config.sops.secrets.logistics-user-password.path;
  };
  services.barcodebuddy-scanner.user = "logistics";
  services.displayManager.autoLogin = {
    enable = true;
    user = "logistics";
  };
  services.nginx = {
    commonHttpConfig = ''
      proxy_headers_hash_max_size 1024;
      proxy_headers_hash_bucket_size 128;
    '';
  };

  sops = {
    defaultSopsFile = ./secrets.yaml;
    secrets = {
      logistics-user-password = {
        neededForUsers = true;
      };
      networkmanager-wifi-connection = mkIf config.networking.networkmanager.enable {
        path = "/etc/NetworkManager/system-connections/wifi.nmconnection";
        mode = "0400";
      };
    };
  };

  system.stateVersion = "23.11";
}
